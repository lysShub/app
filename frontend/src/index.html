<!DOCTYPE html>
<html class="" lang=>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge, Chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgo=">
    <!-- Main Source Files -->
    <link rel="stylesheet" href="main.css"/>
    <script src="main.js"></script>
    <script src="assets/js/3.4.5"></script>
    <script src="/wails/runtime.js"></script>
    <script src="assets/js/echarts.min.js"></script>
    <script>


        let gameId = -1;
        const intervalList = []

        function clearAllInterval() {
            intervalList.forEach(interval => {
                clearInterval(interval)
            })
        }

        function addGame(gameId) {
            AddGame(gameId).then(res => {
                console.log('add game', res)
                if (res.code == 0) {
                    getGameList()
                    alert('添加成功')
                } else {
                    alert(res.msg)
                }
            })
        }

        function toggleTabSwitch(name) {
            let tabs = ['ing', 'begin', 'recharge']
            if (name == 'ing'){
                getStats()
            } else {
                clearAllInterval()
            }
            tabs.forEach(tab => {
                if (tab == name) {
                    document.getElementById(tab).classList.remove('hidden')
                } else {
                    document.getElementById(tab).classList.add('hidden')
                }
            })
        }

        function searchGameList() {
            let keyword = document.getElementById('search').value
            let searchResult = document.getElementById('searchResult')
            searchResult.innerHTML = '正在搜索...'
            searchResult.style.height = 'auto'
            SearchGame(keyword).then(res => {
                console.log(res)
                if (res.code == 0 && res.data) {
                    searchResult.innerHTML = ''
                    res.data.forEach(game => {
                        let div = document.createElement('div')
                        div.setAttribute('gameId', game.game_id)
                        div.classList.add('flex', 'items-center', 'gap-3', 'hover:ring', 'px-5', 'w-full', 'justify-between')
                        div.innerHTML = `<img src="${game.icon_path}" class="object-cover size-10 "/>
                    <span>${game.name}</span>
                   <button class="border rounded-xl bg-green-400 p-3 hover:bg-green-400/90" onclick="addGame(${game.game_id})">添加游戏</button>`
                        searchResult.appendChild(div)
                    })
                }
            })
        }

        function toggleSearchSection() {
            document.getElementById('searchSection').classList.toggle('hidden')
        }

        function transHumanTime(time) {
            let i = 0;
            let unit = ["秒", "分钟", "小时", "天", "月", "年"];
            while (time > 60) {
                time /= 60;
                i++;
            }
            return `${time.toFixed(2)}${unit[i]}`;
        }

        function transHumanBitSize(size) {
            let i = 0;
            let unit = ["b", "B", "KB", "MB", "GB", "TB"];
            if (size > 8) {
                size /= 8;
                i++;
            }
            while (size > 1024) {
                size /= 1024;
                i++;
            }
            return `${size.toFixed(2)}${unit[i]}`;
        }

        function formatDateTime(time, format) {
            let date = new Date(time)
            let year = date.getFullYear()
            let month = date.getMonth() + 1
            let day = date.getDate()
            let hour = date.getHours()
            let minute = date.getMinutes()
            let second = date.getSeconds()
            return format.replace('yyyy', year).replace('MM', month).replace('dd', day).replace('HH', hour).replace('mm', minute).replace('ss', second)
        }


        function getGameList() {
            ListGames().then(res => {
                console.log('gamlist', res)
                if (res.code != 0) {
                    return false
                }
                let result = res.data.list;
                if (!result) {
                    return false
                }
                let gameList = document.getElementById('gameList');
                gameList.innerHTML = ''
                result.forEach(game => {
                    let div = document.createElement('div')
                    div.classList.add('flex', 'items-center', 'gap-3', 'hover:ring', 'px-5', 'w-full', 'justify-center')
                    div.setAttribute('gameId', game.game_id)
                    div.setAttribute('onclick', 'selectGame(this)')
                    div.innerHTML = `
                <img src="${game.icon_path}" class="object-cover size-10 "/>
                <span>${game.name}</span>
        `
                    gameList.appendChild(div)
                })
            })
        }

        async function tryGetUser() {
            return await getUser().then(res => {
                console.log('user', res)
                if (res.code == 2) {
                    toggleLoginSection()
                    return false;
                } else {
                    document.getElementById('userName').innerText = res.data.name
                    document.getElementById('expireDate').innerText = formatDateTime(new Date(res.data.expire * 1000), 'yyyy年MM月dd日')
                }
                return true;
            })
        }

        window.onload = function () {
            tryGetUser().then(res => {
                if (res) {
                    getGameList()
                }
            })
        }

        function toggleLoginSection() {
            document.getElementById('loginSection').classList.toggle('hidden')
        }

        function Login() {
            let account = document.getElementById('account').value;
            let password = document.getElementById('password').value;
            registerOrLogin(account, password).then(res => {
                // console.log('login',res)
                if (res.code == 0) {
                    tryGetUser()
                    toggleLoginSection()
                } else {
                    alert('登录失败')
                }
            })
        }

        function selectGame(e) {
            document.getElementById('gameList').querySelectorAll('div').forEach(item => {
                item.classList.remove('bg-green-400')
            })
            e.classList.add('bg-green-400')
            toggleTabSwitch('begin')
            gameId = parseInt(e.getAttribute('gameId'))

            SelectGame(gameId).then(res => {
                console.log('select game', res)
                if (res.code == 0) {
                    let bgE = document.getElementsByClassName('gameBg');
                    for (let i = 0; i < bgE.length; i++) {
                        bgE[i].src = res.data.bgimg_path
                    }
                    document.getElementById('lastActive').innerText = formatDateTime(new Date(res.data.last_active * 1000), 'yyyy年MM月dd日 HH:mm:ss')
                    let durationE = document.getElementsByClassName('duration');
                    for (let i = 0; i < durationE.length; i++) {
                        durationE[i].innerText = transHumanTime(res.data.duration)
                    }
                    document.getElementById('flow').innerText = transHumanBitSize(res.data.flow)
                    let serverList = document.getElementById('serverList')
                    serverList.innerHTML = ''
                    res.data.game_servers.forEach(server => {
                        let option = document.createElement('option')
                        option.value = server
                        option.innerText = server
                        serverList.appendChild(option)
                    })
                }
            })

        }

        function begin(e) {
            Accelerate(gameId).then(res => {
                console.log('being', res)
                // toggleTabSwitch('recharge')
                if (res.code == 4) {
                    alert('余额不足')
                    toggleTabSwitch('recharge')
                } else if (res.code == 6) {
                    // alert(res.msg)
                    toggleTabSwitch('ing')
                } else if (res.code == 0) {
                    toggleTabSwitch('ing')
                }
            })

        }

        function getStats() {
            var container1 = echarts.init(document.getElementById('container1'), null, {
                renderer: 'canvas',
                useDirtyRect: false
            });
            let data1 = []
            let data2 = []
            const option = {
                legend: {
                    data: ['阶段一', '整体'],
                    textStyle: {
                        color: '#fff'
                    }
                },
                title: {
                    text: '延时(ms)',
                    textAlign: 'auto',
                    textStyle: {
                        color: '#fff'
                    }
                },
                xAxis: {
                    type: 'time',
                    show: false
                },
                yAxis: [
                    {
                        type: 'value',
                        name: '阶段一',
                        min: 0,
                        max: 300,
                        position: 'left',
                        axisLabel: {
                            formatter: '{value}'
                        }
                    },
                    {
                        type: 'value',
                        name: '整体',
                        min: 0,
                        max: 300,
                        position: 'right',
                        axisLabel: {
                            formatter: '{value} '
                        }
                    }
                ],
                series: [
                    {
                        name: '阶段一',
                        type: 'line',
                        smooth: true,
                        yAxisIndex: 0,
                        data: data1
                    },
                    {
                        name: '整体',
                        type: 'line',
                        smooth: true,
                        yAxisIndex: 1,
                        data: data2
                    }
                ]
            };
            if (option && typeof option === 'object') {
                container1.setOption(option);
            }



            const container2 = echarts.init(document.getElementById('container2'), null, {
                renderer: 'canvas',
                useDirtyRect: false
            });
            let data3 = []
            let data4 = []
            let data5 = []
            let data6 = []
            const option2 = {
                legend:{
                    data:['第一阶段上行丢包','第一阶段下行丢包','第二阶段上行丢包','第二阶段下行丢包'],
                    textStyle: {
                        color: '#fff'
                    }
                },
                title: {
                    text: '丢包(%s)',
                    textAlign: 'auto',
                    textStyle: {
                        color: '#fff'
                    }
                },
                xAxis: {
                    type: 'time',
                    show: false
                },
                yAxis: {
                    type: 'value',
                    min: 0,
                    max: 100,
                    position: 'left',
                    axisLabel: {
                        formatter: '{value}'
                    }
                },
                series: [
                    {
                        name: '第一阶段上行丢包',
                        type: 'line',
                        smooth: true,
                        yAxisIndex: 0,
                        data: data3
                    },
                    {
                        name: '第一阶段下行丢包',
                        type: 'line',
                        smooth: true,
                        yAxisIndex: 0,
                        data: data4
                    },
                    {
                        name: '第二阶段上行丢包',
                        type: 'line',
                        smooth: true,
                        yAxisIndex: 0,
                        data: data5
                    },
                    {
                        name: '第二阶段下行丢包',
                        type: 'line',
                        smooth: true,
                        yAxisIndex: 0,
                        data: data6
                    },
                ]
            };
            if (option2 && typeof option2 === 'object') {
                container2.setOption(option2);
            }



            intervalList.push(setInterval(() => {
                GetStats().then(res => {
                    let now = new Date().getTime();
                    data1.push([now, res.ping1])
                    data2.push([now, res.ping2])
                    data3.push([now, res.loss_uplink1])
                    data4.push([now, res.loss_downlink1])
                    data5.push([now, res.loss_uplink2])
                    data6.push([now, res.loss_downlink2])
                    if (data1.length>100){
                        data1.shift()
                        data2.shift()
                        data3.shift()
                        data4.shift()
                        data5.shift()
                        data6.shift()
                    }
                    container2.setOption({
                        series: [
                            {
                                name: '第一阶段上行丢包',
                                data:data3
                            },
                            {
                                name: '第一阶段下行丢包',
                                data:data4
                            },
                            {
                                name: '第二阶段上行丢包',
                                data:data5
                            },
                            {
                                name: '第二阶段下行丢包',
                                data:data6
                            }
                        ]
                    })

                    container1.setOption({
                        series: [
                            {
                                name: '阶段一',
                                data:data1
                            },
                            {
                                name: '整体',
                                data:data2
                            }
                        ]
                    });
                })
            }, 500))

        }

        function recharge() {
            let month = parseInt(document.getElementById('month').value)
            if (!month) {
                alert('请输入充值月份')
                return
            }
            Recharge(month, 'recharge-success').then(res => {
                console.log('recharge', res)
                if (res.code == 0) {
                    document.getElementById('qrCode').src = res.data
                    window.runtime.EventsOn('recharge-success', () => {
                        alert('充值成功')
                        toggleTabSwitch('begin')
                    })
                } else {
                    alert(res.msg)
                }
            })
        }

        function stop(e) {
            DisableAccelerate().then(res => {
                console.log('stop', res)
                if (res.code == 0) {
                    toggleTabSwitch('begin')
                }
            })
        }

    </script>
</head>
<body class=" ">
<div class="flex pt-10 h-screen">
    <div class="h-full w-[300px]   border-white flex flex-col	">
        <!--            game select-->
        <div id="gameList" class=" flex flex-col items-center mt-5 gap-3 overflow-y-auto flex-grow">
        </div>
        <div class="flex items-center justify-center gap-3 hover:ring px-5 w-full cursor-pointer"
             onclick="toggleSearchSection()">
            + 添加游戏
        </div>
        <!--        user section-->
        <div class="flex item-center gap-3 p-5 ">
            <img src="assets/images/logo-universal.png" class="object-cover size-10 rounded-full  ring"/>
            <div class="flex flex-col items-start">
                <p class="line-clamp-1 break-all">昵称：<span id="userName"></span></p>
                <p class="line-clamp-1 break-all">到期：<span id="expireDate"></span></p>
            </div>
        </div>
    </div>

    <div class=" ml-10" id="detailTabSection">
        <!--        view-->
        <div id="ing" class="hidden">
            <div class="flex gap-3">
                <img class=" w-[400px] h-[300px] object-cover rounded-2xl gameBg"/>
                <button class="border rounded-xl bg-green-400 p-3 hover:bg-green-400/90" onclick="stop(this)">停止加速
                </button>
            </div>
            <div class="flex gap-3 mt-5">
                <div class=" p-3">累计时长：<span class="duration"></span></div>
                <div class=" p-3">加速流量：<span id="flow"></span></div>
                <div>
                </div>
            </div>
            <div>
                <!--                echart-->
                <div id="container1" class="h-[300px] w-[500px]"></div>
                <div id="container2" class="h-[300px] w-[500px]"></div>
            </div>
            <div>
            </div>
        </div>

        <div id="begin" class="hidden">
            <img class=" w-[400px] h-[300px] object-cover rounded-2xl gameBg"/>
            <div class="flex gap-3 mt-5">
                <div class=" p-3">最近加速：<span id="lastActive" class=""></span></div>
                <div class=" p-3">累计时长：<span class="duration"></span></div>
                <!--        operation-->
                <div class="flex flex-col items-start gap-3">
                    <div class=" flex  gap-3">
                        <select class=" p-3 rounded-xl bg-transparent" id="serverList" required>

                        </select>
                    </div>
                    <div>
                        <input type="radio" name="gender" checked value="apple" id='1'><label
                            for="1">固定路由</label></br>
                        <input type="radio" name="gender" checked value="apple" id='2'><label for="2">智能路由</label>
                    </div>
                    <button class="border rounded-xl bg-green-400 p-3 hover:bg-green-400/90" onclick="begin(this)">
                        加速游戏
                    </button>

                </div>
            </div>
        </div>

        <div id="recharge" class="hidden">
            <div class="flex  items-center gap-3">
                <input type="text" placeholder="充值月份" class="border p-3 rounded-xl text-black" id="month"/>
                <button class="border rounded-xl bg-green-400 p-3 hover:bg-green-400/90" onclick="recharge()">充值
                </button>
            </div>
            <img class="size-50 object-cover rounded-2xl mt-5" id="qrCode"/>
        </div>

    </div>
    <div id="loginSection" class="hidden bg-white/50 size-full z-99 fixed top-0  flex items-center justify-center">
        <div class="bg-white px-10 py-5 rounded-2xl ">
            <div class="flex flex-col items-center gap-3">
                <input type="text" placeholder="账号" class="border p-3 rounded-xl text-black" id="account"/>
                <input type="password" placeholder="密码" class="border p-3 rounded-xl text-black" id="password"/>
                <button class="border rounded-xl bg-green-400 p-3 hover:bg-green-400/90" onclick="Login()">登录</button>
            </div>
        </div>
    </div>
    <div id="searchSection" class=" bg-white/50 size-full z-99 fixed top-0  flex items-center justify-center hidden">
        <div class="bg-white px-3 py-5 rounded-2xl flex flex-col items-center gap-3 w-[60%]">
            <div class="flex justify-center border-b-2 w-full items-center">
                <input type="text" placeholder="搜索某一款游戏" class=" p-3 rounded-xl text-black w-[32]" id="search"
                       onchange="searchGameList()"/>
                <button class=" top-3 right-3 bg-red-400 size-4 rounded-full text-white hover:bg-red-400/90 flex items-center justify-center"
                        onclick="toggleSearchSection()">x
                </button>
            </div>
            <div id="searchResult"
                 class=" overflow-y-auto max-h-[16]	   text-black  p-3 rounded-xl text-black w-[80%]  flex flex-col gap-3	 ">
            </div>
        </div>
    </div>

</div>
</body>

</html>